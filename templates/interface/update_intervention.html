{% extends 'interface/base.html' %}
{% load static %}
{% block content %}
<!-- //TODO: Refactor with form validation -->
    <br>
    <link rel="stylesheet" href="{% static 'css/interventions.css' %}">
    <h3>Update an Existing Intervention</h3>
    <div class="container">
    <div class="row">
        <div class="col-8">
            <form class="scroll">
                <div class="form-row">
                    <label class="form-label col-sm-6" for="intvName">
                        Name of the intervention: 
                    </label>
                    <input type="text" name="intvName"  value="custom intervention" required="" id="intvName">
                </div>
                <div class="form-group row" id="customIntv">

                    <div id="interv">

                    </div>

                </div>
                <div>
                    <button type="button" class="btn btn-info" id="intvButton">Add Intervention</button>
                </div>
                <br>

                <a class="btn btn-md btn-warning" href="{% url 'profile' %}"><i class="fa fa-angle-left"> </i> Go Back to User Home</a>
                <input class="btn btn-md btn-success" type="button" id="submit" value="submit" />

            </form>
        </div>
        <div class="col">
            <div class="card card-info">
                <div class="card-header">
                    <h5>Steps to build custom intervention</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>Give a name to the intervention to be created</li>
                        <li>Click on the Add Intervention button.</li>
                       <li> Enter the following parameters<br>
                            <ol>
                                <li><strong>Intervention</strong>: Select a single intervention or a combination of interventions through the multiselect option(click one option and drag to select multiple options).</li>
                                <li><strong>Duration of intervention</strong>: Enter the number of days the intervention is imposed.</li>
                                <li><strong>Compliance Probability</strong>: Enter the compliance value at which the intervention is imposed. Compliance value ranges between 0 and 1, where 1 indicates highest compliance.</li>
                            </ol>
                        </li>
                        <li>A minimum of 1 intervention must be added.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    </div>


    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <script src="{% static 'js/interventions.js' %}"></script>
    <script>
	var elemId = 0;

    // var intvJSON = {{ intvJSON | safe  }};

    var intvJSON = [
    {
        "num_days": 6,
        "compliance": 0.5,
        "lockdown": {
            "active": true,
        }
    },
    {
       "num_days": 1,
       "compliance": 0.5,
       "selective_shutdown": {
           "active": true,
           "spaces": [1, 4, 5, 8]
        }
    },
    {
        "num_days": 6,
        "compliance": 0.5,
        "case_isolation": {
            "active": true,
        },
        "class_isolation": {
            "active": false,
        }
    },
    {
        "num_days": 6,
        "no_intervention": {
            "active": true,
        },
        "class_isolation": {
            "active": true,
        }
    },
    {
        "num_days": 1,
        "no_intervention": {
            "active": true,
        }
    },
];



    $("#interv-li").show();
    $("#customIntv").show();

    for(var elem in intvJSON){
        console.log(intvJSON[elem]);
        elemId = existingInterv(intvJSON[elem], elem, elemId);
        elemId += 1;
    }
    console.log(elemId)


	var msg = "Click the 'Add Intervention' button to set-up the simulator to run a custom intervention.<br>";
    $("#interv").html(msg);

    $("#intvButton").on('click', function () {
    newInterv(elemId)
    });

    $("#submit").on('click', function(){
        var intvArr = [];
        var numDaysArr = [];
        var compProbArr = [];


        const NO_INTERVENTION = 0
        for (let i = 0; i < $(".interv-li").length; i++) {
            //check if the values are filled or not
            intvArr.push($("#mulIntv"+i).val());
            numDaysArr.push($("#numDays"+i).val());
            compProbArr.push($("#compProb"+i).val());
        }

        console.log(intvArr, compProbArr, numDaysArr)

        $.ajax({
            url:"{% url 'updateIntervention' pk %}",
            type: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify({
                "intvName": $("#intvName").val(),
                "intvDict": intervention_json_gen(intvArr, compProbArr, numDaysArr)
            }),
            success:function(response){
                alert("Intervention " + $("#intvName").val() + "is now updated in the database. You can use this interevention in simulation jobs.\n You will be redirected to the homepage, now.")
                window.location.href="{% url 'profile' %}"
                // console.log(response)
            },
            complete:function(){},
            error:function (xhr, textStatus, thrownError){
                alert("Error occured while updating Intervention " + $("#intvName").val() + "in the database. Please verify your inputs and try again")
                console.log("error doing something");
            }
        });
    });

    </script>



{% endblock %}
